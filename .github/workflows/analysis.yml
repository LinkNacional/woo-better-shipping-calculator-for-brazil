name: Security and Quality Analysis

on:
  workflow_call:
    outputs:
      analysis_status:
        description: "Status da anÃ¡lise"
        value: ${{ jobs.summary.outputs.status }}
  workflow_dispatch:

env:
  PHP_VERSION: "7.4"

jobs:
  codeql:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: javascript
      - uses: github/codeql-action/autobuild@v3
      - uses: github/codeql-action/analyze@v3

  php-analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer
      - run: composer install --no-dev --optimize-autoloader --ignore-platform-reqs
      - run: composer require --dev vimeo/psalm:^4.30 php-stubs/wordpress-stubs --ignore-platform-reqs
      - name: Create Psalm Config
        run: |
          cat > psalm.xml << 'EOF'
          <?xml version="1.0"?>
          <psalm errorLevel="4">
              <projectFiles>
                  <directory name="Admin" />
                  <directory name="Includes" />
                  <directory name="Public" />
                  <file name="wc-better-shipping-calculator-for-brazil.php" />
                  <ignoreFiles><directory name="vendor" /></ignoreFiles>
              </projectFiles>
              <stubs>
                  <file name="vendor/php-stubs/wordpress-stubs/wordpress-stubs.php" />
              </stubs>
          </psalm>
          EOF
      - run: ./vendor/bin/psalm --no-progress

  plugin-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: php-actions/composer@v6
      with:
        php_version: ${{ env.PHP_VERSION }}
        args: --ignore-platform-reqs
        dev: no
    - uses: wordpress/plugin-check-action@v1
      with:
        build-dir: './'
        categories: 'security,performance'

  summary:
    runs-on: ubuntu-latest
    needs: [codeql, php-analysis, plugin-check]
    if: always()
    outputs:
      status: ${{ steps.check.outputs.status }}
    steps:
    - id: check
      run: |
        if [[ "${{ needs.codeql.result }}" == "success" && "${{ needs.php-analysis.result }}" == "success" && "${{ needs.plugin-check.result }}" == "success" ]]; then
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          exit 1
        fi
