name: Generate Pre-Release

on:
  workflow_call:  # Permite ser chamado por outros workflows
    inputs:
      analysis_status:
        description: 'Status da anÃ¡lise (success/failure)'
        required: false
        type: string
        default: 'success'
  workflow_dispatch:  # Permite execuÃ§Ã£o manual como fallback
    inputs:
      reason:
        description: 'RazÃ£o para execuÃ§Ã£o manual'
        required: false
        default: 'Manual trigger after analysis'

env:
  PLUGIN_NAME: woo-better-shipping-calculator-for-brazil
  PHP_VERSION: "7.4"
  DEPLOY_TAG: "4.4.0-rc.1"

jobs:
  check-analysis-success:
    name: Verify Analysis Success
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_call' && inputs.analysis_status == 'success')
    steps:
    - name: Analysis verification
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "ğŸ”§ Manual execution triggered"
          echo "Reason: ${{ github.event.inputs.reason }}"
        elif [[ "${{ github.event_name }}" == "workflow_call" ]]; then
          echo "ğŸ¯ Triggered by workflow_call from orchestrator"
          echo "Analysis Status: ${{ inputs.analysis_status }}"
          if [[ "${{ inputs.analysis_status }}" != "success" ]]; then
            echo "âŒ Analysis status indicates failure - stopping"
            exit 1
          fi
        fi
        echo "ğŸš€ All checks passed - proceeding with pre-release generation..."

  release-generation:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_call' && inputs.analysis_status == 'success')
    steps:
    - name: ğŸš€ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, mysql, pdo_mysql
        
    - name: ğŸ“¦ Install Composer dependencies
      run: composer install --no-dev --optimize-autoloader
      
    - name: ğŸ—ï¸ Build Plugin Archive
      run: |
        echo "ğŸ—ï¸ Creating plugin archive..."
        
        # Create build directory
        mkdir -p build
        
        # Copy plugin files (exclude development files)
        rsync -av --progress . build/${{ env.PLUGIN_NAME }}/ \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='node_modules' \
          --exclude='build' \
          --exclude='tests' \
          --exclude='.phpunit.result.cache' \
          --exclude='composer.lock' \
          --exclude='package-lock.json' \
          --exclude='webpack.*.js' \
          --exclude='src/' \
          --exclude='.gitignore' \
          --exclude='.editorconfig' \
          --exclude='phpunit.xml' \
          --exclude='psalm.xml'
        
        # Create ZIP archive
        cd build
        zip -r "${{ env.PLUGIN_NAME }}-${{ env.DEPLOY_TAG }}.zip" ${{ env.PLUGIN_NAME }}/
        
        echo "ğŸ“¦ Archive created: ${{ env.PLUGIN_NAME }}-${{ env.DEPLOY_TAG }}.zip"
        ls -la *.zip
        
    - name: ğŸ·ï¸ Create Release
      uses: actions/create-release@v1
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ env.DEPLOY_TAG }}
        release_name: "Release Candidate ${{ env.DEPLOY_TAG }}"
        body: |
          ğŸš€ **Release Candidate ${{ env.DEPLOY_TAG }}**
          
          âœ… **AnÃ¡lises de SeguranÃ§a e Qualidade:** Aprovadas
          ğŸ“¦ **Plugin WordPress:** Pronto para testes
          
          ### ğŸ” VerificaÃ§Ãµes Realizadas:
          - CodeQL Security Analysis
          - PHP Static Analysis (Psalm)
          - WordPress Plugin Check
          
          ### ğŸ“¥ InstalaÃ§Ã£o:
          1. Baixe o arquivo `${{ env.PLUGIN_NAME }}-${{ env.DEPLOY_TAG }}.zip`
          2. FaÃ§a upload via WordPress Admin â†’ Plugins â†’ Adicionar Novo â†’ Enviar Plugin
          3. Ative o plugin
          
          ### âš ï¸ Aviso:
          Esta Ã© uma versÃ£o **Release Candidate** para testes. Use apenas em ambientes de desenvolvimento ou staging.
        draft: false
        prerelease: true
        
    - name: ğŸ“¤ Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./build/${{ env.PLUGIN_NAME }}-${{ env.DEPLOY_TAG }}.zip
        asset_name: ${{ env.PLUGIN_NAME }}-${{ env.DEPLOY_TAG }}.zip
        asset_content_type: application/zip
        
    - name: ğŸ‰ Release Summary
      run: |
        echo "ğŸ‰ Pre-Release criado com sucesso!"
        echo "ğŸ“¦ VersÃ£o: ${{ env.DEPLOY_TAG }}"
        echo "ğŸ”— Release: ${{ steps.create_release.outputs.html_url }}"
        echo "ğŸ“ Arquivo: ${{ env.PLUGIN_NAME }}-${{ env.DEPLOY_TAG }}.zip"
