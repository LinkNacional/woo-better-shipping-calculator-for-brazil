name: Generate Pre-Release

on:
  workflow_call:  # Permite ser chamado por outros workflows
    inputs:
      analysis_status:
        description: 'Status da an√°lise (success/failure)'
        required: false
        type: string
        default: 'success'
  workflow_dispatch:  # Permite execu√ß√£o manual como fallback
    inputs:
      reason:
        description: 'Raz√£o para execu√ß√£o manual'
        required: false
        default: 'Manual trigger after analysis'

env:
  PLUGIN_NAME: woo-better-shipping-calculator-for-brazil
  PHP_VERSION: "7.4"
  DEPLOY_TAG: "4.4.0-rc.1"

jobs:
  check-analysis-success:
    name: Verify Analysis Success
    runs-on: ubuntu-latest
    # S√≥ executa se for manual OU se o workflow_run foi bem-sucedido OU se chamado via workflow_call
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') || (github.event_name == 'workflow_call' && inputs.analysis_status == 'success')
    steps:
    - name: Download analysis artifact (if available)
      if: github.event_name == 'workflow_run'
      uses: actions/download-artifact@v4
      with:
        name: analysis-success-${{ github.event.workflow_run.head_sha }}
        path: analysis-results/
        github-token: ${{ secrets.GITHUB_TOKEN }}
        repository: ${{ github.repository }}
        run-id: ${{ github.event.workflow_run.id }}
      continue-on-error: true
      
    - name: Analysis verification
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "üîß Manual execution triggered"
          echo "Reason: ${{ github.event.inputs.reason }}"
        elif [[ "${{ github.event_name }}" == "workflow_call" ]]; then
          echo "üéØ Triggered by workflow_call from orchestrator"
          echo "Analysis Status: ${{ inputs.analysis_status }}"
          if [[ "${{ inputs.analysis_status }}" != "success" ]]; then
            echo "‚ùå Analysis status indicates failure - stopping"
            exit 1
          fi
        fi
        echo "üöÄ All checks passed - proceeding with pre-release generation..."

  release-generation:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_call' && inputs.analysis_status == 'success')
    steps:
