name: ğŸš€ Pre-Release Pipeline - Analysis and Build

on:
  push:
    branches: ["pre-release"]
    paths:
      - "**.php"
      - "**.js"
      - ".github/workflows/**"
      - "composer.json"
      - "package.json"
      - "readme.txt"
      - "README.md"
      - "CHANGELOG.md"
  pull_request:
    branches: ["pre-release"]
    paths:
      - "**.php"
      - "**.js"
      - ".github/workflows/**"
      - "composer.json"
      - "package.json"
      - "readme.txt"
      - "README.md"
      - "CHANGELOG.md"
  workflow_dispatch:
    inputs:
      reason:
        description: "RazÃ£o para execuÃ§Ã£o manual do pipeline de pre-release"
        required: false
        default: "ExecuÃ§Ã£o manual do pipeline de pre-release"

env:
  PLUGIN_VERSION: "4.4.0-rc.1"

concurrency:
  group: pre-release-pipeline-${{ github.ref }}
  cancel-in-progress: true

jobs:
  security-analysis:
    name: ğŸ›¡ï¸ AnÃ¡lise de SeguranÃ§a e Qualidade
    uses: ./.github/workflows/analysis.yml
    
  pre-release-build:
    name: ğŸ“¦ Build e Release Candidate
    needs: security-analysis
    if: needs.security-analysis.outputs.analysis_status == 'success'
    uses: ./.github/workflows/pre-release.yml
    with:
      analysis_status: ${{ needs.security-analysis.outputs.analysis_status }}
      
  pipeline-summary:
    name: ğŸ“Š RelatÃ³rio do Pipeline
    runs-on: ubuntu-latest
    needs: [security-analysis, pre-release-build]
    if: always()
    
    steps:
    - name: ğŸ“Š RelatÃ³rio Final do Pipeline Pre-Release
      run: |
        echo "ğŸš€ Pipeline Pre-Release - RelatÃ³rio Final"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Branch: pre-release"
        echo "VersÃ£o: ${{ env.PLUGIN_VERSION }}"
        echo "Commit: ${{ github.sha }}"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo "ğŸ› DEBUG - Outputs do Analysis:"
        echo "  - analysis_status: '${{ needs.security-analysis.outputs.analysis_status }}'"
        echo "  - tipo: '${{ type(needs.security-analysis.outputs.analysis_status) }}'"
        echo "ğŸ› DEBUG - Resultados dos Jobs:"
        echo "  - security-analysis.result: '${{ needs.security-analysis.result }}'"
        echo "  - pre-release-build.result: '${{ needs.pre-release-build.result }}'"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo "AnÃ¡lise de SeguranÃ§a: ${{ needs.security-analysis.outputs.analysis_status || 'failed' }}"
        echo "Build Pre-Release: ${{ needs.pre-release-build.result || 'skipped' }}"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        
        if [[ "${{ needs.security-analysis.outputs.analysis_status }}" == "success" ]]; then
          echo "âœ… AnÃ¡lise de SeguranÃ§a e Qualidade: APROVADA"
          if [[ "${{ needs.pre-release-build.result }}" == "success" ]]; then
            echo "âœ… Build e Release Candidate: CONCLUÃDO"
            echo "ğŸ‰ Pipeline executado com sucesso!"
            echo "ğŸ“¦ Release candidate ${{ env.PLUGIN_VERSION }} disponÃ­vel!"
          elif [[ "${{ needs.pre-release-build.result }}" == "skipped" ]]; then
            echo "â­ï¸ Build Pre-Release: PULADO"
            echo "â„¹ï¸ Build foi pulado devido a falha na anÃ¡lise"
          else
            echo "âŒ Build Pre-Release: FALHOU"
            echo "âš ï¸ Pipeline falhou na etapa de build"
          fi
        else
          echo "âŒ AnÃ¡lise de SeguranÃ§a e Qualidade: FALHOU"
          echo "â­ï¸ Build Pre-Release: PULADO"
          echo "ğŸ›‘ Pipeline interrompido devido a falhas na anÃ¡lise"
          echo "ğŸ”§ Corrija os problemas encontrados na anÃ¡lise antes de prosseguir"
        fi
        
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo "ğŸ”— Verifique os logs dos jobs acima para mais detalhes"
